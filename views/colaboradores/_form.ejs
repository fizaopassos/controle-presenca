<%
const isNovo = (acao === 'novo');

const postUrl  = isNovo
  ? '/colaboradores/novo'
  : '/colaboradores/editar/' + colaborador.id;

const hxTarget = isNovo
  ? '#tabelaColaboradores'
  : '#colaborador-' + colaborador.id;

const hxSwap = isNovo ? 'beforeend' : 'outerHTML';
%>

<form
  id="formColaboradorHtmx"
  class="row g-3"
  method="post"
>
  <div class="col-12">
    <h5 class="mb-2"><%= isNovo ? 'Novo Colaborador' : 'Editar Colaborador' %></h5>
  </div>

  <!-- Área de alerta dentro do modal -->
  <div class="col-12" id="alertaColaboradorModal"></div>

  <div class="col-12 col-lg-6">
    <label class="form-label" for="nome">Nome *</label>
    <input
      class="form-control"
      id="nome"
      name="nome"
      required
      value="<%= colaborador ? colaborador.nome : '' %>"
    >
  </div>

  <div class="col-12 col-lg-3">
    <label class="form-label" for="empresa_id">Empresa *</label>
    <select class="form-select" id="empresa_id" name="empresa_id" required>
      <option value="">Selecione...</option>
      <% empresas.forEach(e => { %>
        <option value="<%= e.id %>" <%= (colaborador && colaborador.empresa_id === e.id) ? 'selected' : '' %>>
          <%= e.nome %>
        </option>
      <% }) %>
    </select>
  </div>

  <div class="col-12 col-lg-3">
    <label class="form-label" for="tipo">Tipo *</label>
    <select class="form-select" id="tipo" name="tipo" required>
      <%
      const tipoAtual = colaborador && colaborador.tipo ? colaborador.tipo : 'fixo';
      %>
      <option value="fixo" <%= tipoAtual === 'fixo' ? 'selected' : '' %>>Fixo</option>
      <option value="cobertura" <%= tipoAtual === 'cobertura' ? 'selected' : '' %>>Cobertura</option>
    </select>
  </div>

  <div class="col-12 col-lg-6" id="grupoCondominio">
    <label class="form-label" id="labelCondominio" for="condominio_id">Condomínio</label>
    <select class="form-select" id="condominio_id" name="condominio_id">
      <option value="">Selecione...</option>
      <% condominios.forEach(cond => { %>
        <option value="<%= cond.id %>" <%= (colaborador && colaborador.condominio_id === cond.id) ? 'selected' : '' %>>
          <%= cond.nome %>
        </option>
      <% }) %>
    </select>
    <small class="text-muted" id="helpCondominio">
      Para colaboradores de Cobertura, este campo pode ficar em branco.
    </small>
  </div>

  <div class="col-12 col-lg-6">
    <label class="form-label" id="labelPosto" for="posto_id">Posto</label>
    <select class="form-select" id="posto_id" name="posto_id">
      <option value="">Selecione...</option>
      <% postos.forEach(p => { %>
        <option value="<%= p.id %>" <%= (colaborador && colaborador.posto_id === p.id) ? 'selected' : '' %>>
          <%= p.nome %>
        </option>
      <% }) %>
    </select>
    <small class="text-muted" id="helpPosto">
      Para colaboradores de Cobertura, este campo pode ficar em branco.
    </small>
  </div>

  <% if (!isNovo) { %>
    <div class="col-12">
      <div class="form-check form-switch">
        <input
          class="form-check-input"
          type="checkbox"
          name="ativo"
          id="ativo"
          <%= colaborador && colaborador.ativo ? 'checked' : '' %>
        >
        <label class="form-check-label" for="ativo">Ativo</label>
      </div>
    </div>
  <% } %>

  <div class="col-12 d-flex justify-content-end gap-2 mt-2">
    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
      Cancelar
    </button>
    <button
      type="button"
      class="btn btn-primary"
      data-confirm="1"
      data-confirm-title="Confirmar <%= isNovo ? 'cadastro' : 'edição' %>"
      data-confirm-body="Deseja realmente <%= isNovo ? 'cadastrar' : 'salvar as alterações' %> deste colaborador?"
      data-confirm-ok="Sim, continuar"
      hx-post="<%= postUrl %>"
      hx-target="<%= hxTarget %>"
      hx-swap="<%= hxSwap %>"
      hx-trigger="confirmed"
      hx-include="#formColaboradorHtmx"
    >
      Salvar
    </button>
  </div>
</form>

<script>
(function () {
  const tipo = document.getElementById('tipo');
  const cond = document.getElementById('condominio_id');
  const posto = document.getElementById('posto_id');

  const grupoCondominio = document.getElementById('grupoCondominio');
  const labelCond = document.getElementById('labelCondominio');
  const labelPosto = document.getElementById('labelPosto');
  const helpCond = document.getElementById('helpCondominio');
  const helpPosto = document.getElementById('helpPosto');

  if (!tipo || !cond || !posto) return;

  function aplicarRegra() {
    const tipoVal = (tipo.value || '').toLowerCase();
    const ehFixo = tipoVal === 'fixo';

    cond.required = ehFixo;
    posto.required = ehFixo;

    if (grupoCondominio) {
      if (ehFixo) {
        grupoCondominio.style.display = '';
      } else {
        grupoCondominio.style.display = 'none';
        cond.value = '';
      }
    }

    if (labelCond) labelCond.textContent = ehFixo ? 'Condomínio *' : 'Condomínio';
    if (labelPosto) labelPosto.textContent = ehFixo ? 'Posto *' : 'Posto';

    if (helpCond) helpCond.textContent = ehFixo
      ? 'Para colaboradores FIXOS, este campo é obrigatório.'
      : 'Para colaboradores de Cobertura, este campo pode ficar em branco.';

    if (helpPosto) helpPosto.textContent = ehFixo
      ? 'Para colaboradores FIXOS, este campo é obrigatório.'
      : 'Para colaboradores de Cobertura, este campo pode ficar em branco.';
  }

  tipo.addEventListener('change', aplicarRegra);
  aplicarRegra();
})();
</script>
