<div class="container mt-4">
  <h1 class="h4 mb-4">Lançar Presença Diária</h1>

  <div class="card mb-3">
    <div class="card-body">
      <form id="formFiltro" class="row g-3">
        <div class="col-md-7">
          <label class="form-label">Condomínio *</label>
          <select class="form-select" id="inputCondominio" name="condominio_id" required>
            <option value="">Selecione...</option>
            <% condominios.forEach(cond => { %>
              <option value="<%= cond.id %>"><%= cond.nome %></option>
            <% }) %>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Data *</label>
          <input type="text" class="form-control" id="inputData" name="data" required>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <button type="button" id="btnBuscar" class="btn btn-primary w-100" disabled>Buscar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
    <button type="button" class="btn btn-outline-success btn-sm" id="btnSelecionarTodosPresente" disabled>
      Selecionar todos: Presente
    </button>

    <button type="button" class="btn btn-success btn-sm" id="btnConfirmarTudo" disabled>
      Confirmar lançamentos
    </button>

    <span class="ms-auto text-muted" id="resumo"></span>
  </div>

  <div id="alerta" class="alert d-none" role="alert"></div>

  <div id="areaColaboradores">
    <div class="alert alert-info">
      Selecione o condomínio e a data para carregar os colaboradores.
    </div>
  </div>
</div>

<div class="modal fade" id="confirmLancamentoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar lançamentos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirmLancamentoBody">
        <!-- texto da confirmação entra via JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button type="button" class="btn btn-primary" id="btnConfirmarLancamentoModal">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .flatpickr-day.dia-vermelho {
    position: relative;
  }
  .flatpickr-day.dia-vermelho::after {
    content: "";
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #dc3545;
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
  }

  .flatpickr-day.dia-amarelo {
    position: relative;
  }
  .flatpickr-day.dia-amarelo::after {
    content: "";
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #ffc107;
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
  }

  .flatpickr-day.dia-verde {
    position: relative;
  }
  .flatpickr-day.dia-verde::after {
    content: "";
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #198754;
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {

  var STATUSES = [
    { key: 'presente', label: 'Presente', btn: 'btn-outline-success', btnActive: 'btn-success' },
    { key: 'falta',    label: 'Falta',    btn: 'btn-outline-danger',  btnActive: 'btn-danger' },
    { key: 'folga',    label: 'Folga',    btn: 'btn-outline-secondary', btnActive: 'btn-secondary' },
    { key: 'atestado', label: 'Atestado', btn: 'btn-outline-warning', btnActive: 'btn-warning' },
    { key: 'ferias',   label: 'Férias',   btn: 'btn-outline-info',    btnActive: 'btn-info' }
  ];

  var STATUS_COM_OBS = ['falta', 'folga', 'atestado', 'ferias'];
  var STATUS_COM_COBERTURA = ['falta', 'folga', 'atestado', 'ferias'];

  var payloadLancamento = null;
  var modalConfirmLanc = null;

  var modalEl = document.getElementById('confirmLancamentoModal');
  if (modalEl && window.bootstrap) {
    modalConfirmLanc = new bootstrap.Modal(modalEl);
  }

  var inputData = document.getElementById('inputData');
  var inputCondominio = document.getElementById('inputCondominio');
  var btnBuscar = document.getElementById('btnBuscar');
  var btnConfirmarTudo = document.getElementById('btnConfirmarTudo');
  var btnSelecionarTodosPresente = document.getElementById('btnSelecionarTodosPresente');
  var areaColaboradores = document.getElementById('areaColaboradores');
  var resumo = document.getElementById('resumo');
  var alerta = document.getElementById('alerta');

  var estado = {};
  var listaIds = [];
  window.__colaboradoresRaw = {};

  window.__coberturasPorEmpresa = {};
  window.__coberturasLoading = {};

  function hojeISO() {
    var d = new Date();
    var yyyy = d.getFullYear();
    var mm = String(d.getMonth() + 1).padStart(2, '0');
    var dd = String(d.getDate()).padStart(2, '0');
    return yyyy + '-' + mm + '-' + dd;
  }

  function showAlert(type, msg, timeoutMs) {
    alerta.className = 'alert alert-' + type;
    alerta.textContent = msg;
    alerta.classList.remove('d-none');
    var t = (typeof timeoutMs === 'number') ? timeoutMs : 3500;
    if (t > 0) setTimeout(function() { alerta.classList.add('d-none'); }, t);
  }

  function badgeStatus(status) {
    if (!status) return { cls: 'bg-light text-dark', text: 'Não lançado' };
    if (status === 'presente') return { cls: 'bg-success', text: 'Presente' };
    if (status === 'falta') return { cls: 'bg-danger', text: 'Falta' };
    if (status === 'folga') return { cls: 'bg-secondary', text: 'Folga' };
    if (status === 'atestado') return { cls: 'bg-warning text-dark', text: 'Atestado' };
    if (status === 'ferias') return { cls: 'bg-info text-dark', text: 'Férias' };
    return { cls: 'bg-light text-dark', text: status };
  }

  function escapeHtml(str) {
    return String(str || '')
      .replace(/&/g, '&')
      .replace(/</g, '<')
      .replace(/>/g, '>')
      .replace(/"/g, '"')
      .replace(/'/g, '');
  }

  function needsCobertura(status) {
    return STATUS_COM_COBERTURA.indexOf(status) !== -1;
  }

  function isPendente(id) {
    var s = estado[String(id)];
    if (!s) return false;

    var mudouStatus = (s.status !== s.originalStatus);
    var mudouObs = ((s.observacoes || '') !== (s.originalObs || ''));
    var mudouCob = ((s.cobertura_id || null) !== (s.originalCobertura_id || null));
    var naoSalvoAinda = !s.presenca_id;

    return mudouStatus || mudouObs || mudouCob || naoSalvoAinda;
  }

  function shouldEnviar(id) {
    var s = estado[String(id)];
    if (!s) return false;

    var temStatusAtual = s.status && s.status !== '';
    var tinhaStatusOriginal = s.originalStatus && s.originalStatus !== '';

    if (!tinhaStatusOriginal && temStatusAtual) {
      return true;
    }

    var mudouStatus = (s.status !== s.originalStatus);
    var mudouObs = ((s.observacoes || '') !== (s.originalObs || ''));
    var mudouCob = ((s.cobertura_id || null) !== (s.originalCobertura_id || null));

    return mudouStatus || mudouObs || mudouCob;
  }

  function getIdsParaProcessar() {
    return listaIds.filter(function(id) {
      return shouldEnviar(String(id));
    });
  }

  function atualizarResumo() {
    var total = listaIds.length;
    var idsProcessar = getIdsParaProcessar();
    var pendentes = 0;
    var jaSalvos = 0;

    idsProcessar.forEach(function(id) {
      if (isPendente(id)) pendentes++;
      else jaSalvos++;
    });

    resumo.textContent =
      'Total: ' + total +
      ' | Selecionados para lançamento: ' + idsProcessar.length +
      ' | Pendentes: ' + pendentes +
      ' | Já salvos: ' + jaSalvos;

    btnConfirmarTudo.disabled = (idsProcessar.length === 0);
    btnSelecionarTodosPresente.disabled = (total === 0);
  }

  function getCoberturasCached(empresaId) {
    if (!empresaId) return null;
    return window.__coberturasPorEmpresa[String(empresaId)] || null;
  }

  function carregarCoberturasEmpresa(empresaId, onDone) {
    var key = String(empresaId || '');
    if (!key) {
      if (typeof onDone === 'function') onDone(null);
      return;
    }

    if (window.__coberturasPorEmpresa[key]) {
      if (typeof onDone === 'function') onDone(window.__coberturasPorEmpresa[key]);
      return;
    }

    if (window.__coberturasLoading[key]) {
      setTimeout(function() { carregarCoberturasEmpresa(empresaId, onDone); }, 150);
      return;
    }

    window.__coberturasLoading[key] = true;

    fetch('/presenca/api/coberturas/empresa/' + encodeURIComponent(key))
      .then(function(resp) { return resp.json(); })
      .then(function(lista) {
        if (!Array.isArray(lista)) lista = [];
        window.__coberturasPorEmpresa[key] = lista;
        window.__coberturasLoading[key] = false;
        if (typeof onDone === 'function') onDone(lista);
      })
      .catch(function(e) {
        console.error(e);
        window.__coberturasPorEmpresa[key] = [];
        window.__coberturasLoading[key] = false;
        if (typeof onDone === 'function') onDone([]);
      });
  }

  var buscaCoberturaTimeout = null;

function buscarCoberturasPorNome(empresaId, termo, callback) {
  if (!empresaId || !termo || termo.length < 2) {
    if (typeof callback === 'function') callback([]);
    return;
  }

  var url = '/presenca/api/colaboradores/buscar?empresa_id='
    + encodeURIComponent(empresaId)
    + '&q=' + encodeURIComponent(termo);

  fetch(url)
    .then(function(resp) { return resp.json(); })
    .then(function(lista) {
      if (!Array.isArray(lista)) lista = [];
      if (typeof callback === 'function') callback(lista);
    })
    .catch(function(e) {
      console.error('Erro ao buscar coberturas por nome:', e);
      if (typeof callback === 'function') callback([]);
    });
}


  function buildCoberturaSelectHtml(c, s) {
  var statusAtual = (s.status != null && s.status !== '') ? s.status : '';
  var mostrar = needsCobertura(statusAtual); // só mostra se for falta/folga/...

  var wrapClass = mostrar ? '' : 'd-none';
  var empresaId = c.empresa_id ? String(c.empresa_id) : '';

  var valorInput = s.cobertura_nome || '';

  return ''
    + '<div class="mt-2 ' + wrapClass + '" id="cob-wrap-' + escapeHtml(c.id) + '">'
    + '  <label class="form-label mb-1">Cobertura (opcional)</label>'
    + '  <input type="text"'
    + '         class="form-control form-control-sm"'
    + '         placeholder="Digite o nome do colaborador..."'
    + '         value="' + escapeHtml(valorInput) + '"'
    + '         data-action="cobertura-input"'
    + '         data-id="' + escapeHtml(c.id) + '"'
    + '         data-empresa-id="' + escapeHtml(empresaId) + '">'
    + '  <div class="list-group position-absolute w-100 d-none"'
    + '       id="cob-suggestions-' + escapeHtml(c.id) + '"'
    + '       style="z-index: 1050; max-height: 200px; overflow-y: auto;"></div>'
    + '</div>';
}


  function renderCard(c) {
    var id = String(c.id);
    var s = estado[id] || {};
    var statusAtual = (s.status != null && s.status !== '') ? s.status : '';
    var obsAtual = s.observacoes || '';
    var expanded = s.expanded ? true : false;

    var badge = badgeStatus(statusAtual);
    var pendente = isPendente(id);

    var borderClass =
      statusAtual === 'presente' ? 'border-success' :
      statusAtual === 'falta' ? 'border-danger' :
      'border-secondary';

    var pendBadge = pendente
      ? '<span class="badge bg-primary">Pendente</span>'
      : '<span class="badge bg-success">Confirmado</span>';

    var btns = '';
    STATUSES.forEach(function(st) {
      var active = (st.key === statusAtual);
      var cls = active ? st.btnActive : st.btn;
      btns += '<button type="button" class="btn ' + cls + ' btn-sm" data-action="set-status" data-id="' + id + '" data-status="' + st.key + '">' + st.label + '</button> ';
    });

    var obsVisible = STATUS_COM_OBS.indexOf(statusAtual) !== -1;
    var obsHtml = ''
      + '<div class="mt-2 ' + (obsVisible ? '' : 'd-none') + '" id="obs-wrap-' + id + '">'
      + '  <label class="form-label mb-1">Observação</label>'
      + '  <input type="text" class="form-control form-control-sm" id="obs-' + id + '" '
      + '         placeholder="Ex: Folga autorizada, Atestado entregue..." '
      + '         value="' + escapeHtml(obsAtual) + '" data-action="set-obs" data-id="' + id + '">'
      + '</div>';

    var empresaText = escapeHtml(c.empresa || 'Sem empresa');
    var postoText = c.posto_nome ? ' • ' + escapeHtml(c.posto_nome) : '';

    var chevron = expanded ? '▼' : '►';
    var detalhesClass = expanded ? '' : 'd-none';

    var coberturaHtml = buildCoberturaSelectHtml(c, s);

    return ''
      + '<div id="card-' + id + '" class="card mb-2 border-start border-3 ' + borderClass + '">'
      + '  <div class="card-body p-3">'

      + '    <div class="d-flex justify-content-between align-items-center gap-3">'
      + '      <button type="button" class="btn btn-link p-0 text-decoration-none text-start flex-grow-1"'
      + '              data-action="toggle-details" data-id="' + id + '">'
      + '        <div class="fw-semibold">' + escapeHtml(c.nome) + '</div>'
      + '        <div class="text-muted small">' + empresaText + postoText + '</div>'
      + '      </button>'

      + '      <div class="text-end" style="min-width: 140px;">'
      + '        <div><span class="badge ' + badge.cls + '">' + badge.text + '</span></div>'
      + '        <div class="mt-1">' + pendBadge + '</div>'
      + '      </div>'

      + '      <button type="button" class="btn btn-outline-secondary btn-sm"'
      + '              data-action="toggle-details" data-id="' + id + '"'
      + '              aria-label="Expandir/Recolher">'
      +          chevron
      + '      </button>'
      + '    </div>'

      + '    <div id="detalhes-' + id + '" class="mt-3 ' + detalhesClass + '">'
      + '      <div class="d-flex flex-wrap gap-2">'
      +          btns
      + '      </div>'
      +        coberturaHtml
      +        obsHtml
      + '    </div>'

      + '  </div>'
      + '</div>';
  }

  function rerenderCardById(id) {
    var raw = window.__colaboradoresRaw[String(id)];
    if (!raw) return;
    var el = document.getElementById('card-' + String(id));
    if (!el) return;
    el.outerHTML = renderCard(raw);
  }

  function ensureCoberturaLoadedIfNeededForCard(id) {
    var raw = window.__colaboradoresRaw[String(id)];
    var s = estado[String(id)];
    if (!raw || !s) return;

    var status = (s.status != null && s.status !== '') ? s.status : '';
    if (!needsCobertura(status)) return;

    var empresaId = raw.empresa_id;
    if (!empresaId) return;

    if (getCoberturasCached(String(empresaId)) === null) {
      carregarCoberturasEmpresa(String(empresaId), function() {
        rerenderCardById(id);
      });
    }
  }

  function buscarColaboradores() {
    var data = inputData.value;
    var condId = inputCondominio.value;

    if (!data || !condId) {
      showAlert('warning', 'Preencha data e condomínio.');
      return;
    }

    alerta.classList.add('d-none');

    areaColaboradores.innerHTML =
      '<div class="text-center py-4"><div class="spinner-border" role="status"></div><div class="mt-2">Carregando colaboradores...</div></div>';

    fetch('/presenca/api/colaboradores/condominio/' + condId + '?data=' + encodeURIComponent(data))
      .then(function(resp) { return resp.json(); })
      .then(function(colaboradores) {
        if (!Array.isArray(colaboradores) || colaboradores.length === 0) {
          estado = {};
          listaIds = [];
          window.__colaboradoresRaw = {};
          areaColaboradores.innerHTML = '<div class="alert alert-warning">Nenhum colaborador encontrado para este condomínio.</div>';
          atualizarResumo();
          return;
        }

        estado = {};
        listaIds = colaboradores.map(function(c) { return String(c.id); });
        window.__colaboradoresRaw = {};

        colaboradores.forEach(function(c) {
          var id = String(c.id);
          window.__colaboradoresRaw[id] = c;

          var originalStatus = c.status || '';
          var originalObs = c.observacoes || '';
          var originalCob = c.cobertura_id || null;

          estado[id] = {
            status: originalStatus,
            observacoes: originalObs,
            cobertura_id: originalCob,
            cobertura_nome: c.cobertura_nome,

            originalStatus: originalStatus,
            originalObs: originalObs,
            originalCobertura_id: originalCob,

            presenca_id: c.presenca_id || null,
            expanded: false
          };
        });

        var html = '';
        colaboradores.forEach(function(c) {
          html += renderCard(c);
        });
        areaColaboradores.innerHTML = html;

        atualizarResumo();
      })
      .catch(function(e) {
        console.error(e);
        areaColaboradores.innerHTML = '<div class="alert alert-danger">Erro ao buscar colaboradores.</div>';
        estado = {};
        listaIds = [];
        window.__colaboradoresRaw = {};
        atualizarResumo();
      });
  }

  // ========================================
  // FLATPICKR: calendário com indicadores coloridos
  // ========================================
  var statusDiasPorData = {};
  var fpData = null;

  function pad2(n) { return String(n).padStart(2, '0'); }

  function mesAtualPicker() {
    if (!fpData) return null;
    var y = fpData.currentYear;
    var m = fpData.currentMonth + 1;
    return y + '-' + pad2(m);
  }

  function carregarDiasLancadosDoMes() {
    var condId = inputCondominio.value;
    if (!condId || !fpData) {
      statusDiasPorData = {};
      if (fpData) fpData.redraw();
      return;
    }

    var mes = mesAtualPicker();
    fetch('/presenca/api/dias-lancados?condominio_id=' + encodeURIComponent(condId) + '&mes=' + encodeURIComponent(mes))
      .then(function(r) { return r.json(); })
      .then(function(obj) {
        if (typeof obj !== 'object' || obj === null) obj = {};
        statusDiasPorData = obj;
        fpData.redraw();
      })
      .catch(function(e) {
        console.error(e);
        statusDiasPorData = {};
        fpData.redraw();
      });
  }

  // Sempre preenche o input com hoje (fallback)
  inputData.value = hojeISO();

  // Inicializa o flatpickr (se existir)
  if (typeof window.flatpickr === 'function') {
    fpData = flatpickr(inputData, {
      dateFormat: 'Y-m-d',
      defaultDate: inputData.value,
      disableMobile: true,
      locale: flatpickr.l10ns.pt,

      onReady: function() {
        carregarDiasLancadosDoMes();
      },
      onMonthChange: function() {
        carregarDiasLancadosDoMes();
      },
      onYearChange: function() {
        carregarDiasLancadosDoMes();
      },

      onDayCreate: function(dObj, dStr, instance, dayElem) {
        try {
          var d = dayElem.dateObj;
          var iso = d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate());
          var status = statusDiasPorData[iso];

          if (status === 'verde') {
            dayElem.classList.add('dia-verde');
            dayElem.setAttribute('title', 'Dia completo: todos confirmados');
          } else if (status === 'amarelo') {
            dayElem.classList.add('dia-amarelo');
            dayElem.setAttribute('title', 'Dia parcial: faltam colaboradores');
          } else if (status === 'vermelho') {
            dayElem.classList.add('dia-vermelho');
            dayElem.setAttribute('title', 'Dia sem lançamentos');
          }
        } catch (e) {}
      }
    });
  } else {
    console.warn('flatpickr não carregou. Verifique o script no layout.ejs');
  }

  inputCondominio.addEventListener('change', function() {
    btnBuscar.disabled = !this.value;
    carregarDiasLancadosDoMes();
  });

  btnBuscar.addEventListener('click', buscarColaboradores);

  // Clique/ações dentro dos cards
  areaColaboradores.addEventListener('click', function(evt) {
    var tg = evt.target.closest('[data-action="toggle-details"]');
    if (tg) {
      var idT = String(tg.getAttribute('data-id'));
      var st = estado[idT];
      if (st) {
        st.expanded = !st.expanded;
        estado[idT] = st;
        rerenderCardById(idT);
        atualizarResumo();

        if (st.expanded) ensureCoberturaLoadedIfNeededForCard(idT);
      }
      return;
    }

      // Clique em uma sugestão de cobertura
  var sug = evt.target.closest('button[data-action="cobertura-suggestion"]');
  if (sug) {
    var baseId = String(sug.getAttribute('data-base-id')); // id do colaborador base
    var colabId = String(sug.getAttribute('data-colab-id'));
    var colabNome = sug.getAttribute('data-colab-nome') || '';

    var s2 = estado[baseId];
    if (!s2) return;

    s2.cobertura_id = Number(colabId);
    s2.cobertura_nome = colabNome;
    estado[baseId] = s2;

    // Atualiza o input de texto com o nome escolhido
    var inp = document.querySelector('input[data-action="cobertura-input"][data-id="' + baseId + '"]');
    if (inp) {
      inp.value = colabNome;
    }

    // Esconde a lista de sugestões
    var sugDiv2 = document.getElementById('cob-suggestions-' + baseId);
    if (sugDiv2) {
      sugDiv2.innerHTML = '';
      sugDiv2.classList.add('d-none');
    }

    atualizarResumo();
    return;
  }


    var btn = evt.target.closest('button[data-action="set-status"]');
    if (!btn) return;

    var id = String(btn.getAttribute('data-id'));
    var novoStatus = btn.getAttribute('data-status');

    var s = estado[id];
    if (!s) return;

    s.status = novoStatus;

    if (STATUS_COM_OBS.indexOf(novoStatus) === -1) {
      s.observacoes = '';
    }

    if (!needsCobertura(novoStatus)) {
      s.cobertura_id = null;
    }

    if (novoStatus === 'presente') {
      s.expanded = false;
    } else if (needsCobertura(novoStatus)) {
      s.expanded = true;
    } else {
      s.expanded = false;
    }

    estado[id] = s;
    rerenderCardById(id);
    atualizarResumo();

    if (needsCobertura(novoStatus)) {
      ensureCoberturaLoadedIfNeededForCard(id);
    }
  });

  areaColaboradores.addEventListener('input', function(evt) {
      // AUTOCOMPLETE COBERTURA: digitação no campo de cobertura
  var inpCob = evt.target.closest('input[data-action="cobertura-input"]');
  if (inpCob) {
    var id = String(inpCob.getAttribute('data-id'));
    var empresaId = inpCob.getAttribute('data-empresa-id') || '';
    var termo = inpCob.value || '';

    // Atualiza apenas o nome no estado; o id só muda quando clicar na sugestão
    var s = estado[id];
    if (!s) return;
    s.cobertura_nome = termo;
    // Não zera cobertura_id aqui para não perder se o cara só corrigiu um detalhe

    if (buscaCoberturaTimeout) clearTimeout(buscaCoberturaTimeout);
    buscaCoberturaTimeout = setTimeout(function() {
      buscarCoberturasPorNome(empresaId, termo, function(lista) {
        var sugDiv = document.getElementById('cob-suggestions-' + id);
        if (!sugDiv) return;

        if (!termo || lista.length === 0) {
          sugDiv.innerHTML = '';
          sugDiv.classList.add('d-none');
          return;
        }

        var html = '';
        lista.forEach(function(col) {
          var label = col.nome;
          if (col.condominio_nome) {
            label += ' - ' + col.condominio_nome;
          }
          label += ' (' + (col.tipo === 'cobertura' ? 'Cobertura' : 'Fixo') + ')';

          html += ''
            + '<button type="button"'
            + '        class="list-group-item list-group-item-action"'
            + '        data-action="cobertura-suggestion"'
            + '        data-base-id="' + escapeHtml(id) + '"'
            + '        data-colab-id="' + escapeHtml(String(col.id)) + '"'
            + '        data-colab-nome="' + escapeHtml(col.nome) + '">'
            +        escapeHtml(label)
            + '</button>';
        });

        sugDiv.innerHTML = html;
        sugDiv.classList.remove('d-none');
      });
    }, 250); // debounce 250ms

    return;
  }

    var inp = evt.target.closest('input[data-action="set-obs"]');
    if (!inp) return;

    var id = String(inp.getAttribute('data-id'));
    var s = estado[id];
    if (!s) return;

    s.observacoes = inp.value || '';
    estado[id] = s;

    atualizarResumo();
  });

  areaColaboradores.addEventListener('change', function(evt) {
    var sel = evt.target.closest('select[data-action="set-cobertura"]');
    if (!sel) return;

    var id = String(sel.getAttribute('data-id'));
    var s = estado[id];
    if (!s) return;

    var val = sel.value ? Number(sel.value) : null;
    s.cobertura_id = val;

    var status = (s.status != null && s.status !== '') ? s.status : '';
    if (needsCobertura(status) && s.cobertura_id) {
      s.expanded = false;
    }

    estado[id] = s;
    rerenderCardById(id);
    atualizarResumo();
  });

  btnSelecionarTodosPresente.addEventListener('click', function() {
    listaIds.forEach(function(id) {
      var s = estado[String(id)];
      if (!s) return;

      s.status = 'presente';
      s.observacoes = '';
      s.cobertura_id = null;
      s.expanded = false;

      estado[String(id)] = s;
      rerenderCardById(String(id));
    });
    atualizarResumo();
  });

  btnConfirmarTudo.addEventListener('click', function() {
    var data = inputData.value;
    var condId = inputCondominio.value;

    if (!data || !condId) {
      showAlert('warning', 'Preencha data e condomínio.');
      return;
    }

    if (listaIds.length === 0) {
      showAlert('warning', 'Nenhum colaborador para confirmar.');
      return;
    }

    var idsParaProcessar = getIdsParaProcessar();

    if (idsParaProcessar.length === 0) {
      showAlert('warning', 'Nenhum colaborador teve status/observação/cobertura definido ou alterado.');
      return;
    }

    var condominioTexto = inputCondominio.options[inputCondominio.selectedIndex].text;

    var msgHtml =
      'Confirma salvar os lançamentos?<br><br>' +
      'Data: <strong>' + escapeHtml(data) + '</strong><br>' +
      'Condomínio: <strong>' + escapeHtml(condominioTexto) + '</strong><br>' +
      'Total de colaboradores: <strong>' + idsParaProcessar.length + '</strong><br><br>' +
      'Isso vai gravar/atualizar as presenças no sistema.';

    var presencas = idsParaProcessar.map(function(id) {
      var s = estado[String(id)];
      var raw = window.__colaboradoresRaw[String(id)];

      var postoIdColab = raw && raw.posto_id ? raw.posto_id : null;

      return {
        colaborador_id: Number(id),
        status: (s && s.status) ? s.status : '',
        observacoes: ((s && s.observacoes) ? s.observacoes : '').trim(),
        posto_id: postoIdColab,
        cobertura_id: (s && s.cobertura_id) ? s.cobertura_id : null
      };
    });

    payloadLancamento = {
      data: data,
      condId: condId,
      presencas: presencas
    };

    var bodyEl = document.getElementById('confirmLancamentoBody');
    if (bodyEl) {
      bodyEl.innerHTML = msgHtml;
    }

    if (modalConfirmLanc) {
      modalConfirmLanc.show();
    } else {
      if (confirm(msgHtml.replace(/<br>/g, '\n').replace(/<[^>]+>/g, ''))) {
        enviarLancamentos();
      }
    }
  });

  function enviarLancamentos() {
    if (!payloadLancamento) return;

    var data = payloadLancamento.data;
    var condId = payloadLancamento.condId;
    var presencas = payloadLancamento.presencas;

    btnConfirmarTudo.disabled = true;

    fetch('/presenca/api/lancar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        data: data,
        condominio_id: condId,
        presencas: presencas
      })
    })
    .then(function(resp) { return resp.json(); })
    .then(function(result) {
      if (!result.success) {
        showAlert('danger', result.message || 'Erro ao salvar presenças.', 5000);
        btnConfirmarTudo.disabled = false;
        return;
      }

      showAlert('success', 'Presenças confirmadas com sucesso!');
      payloadLancamento = null;
      
      // Recarrega colaboradores e atualiza indicadores do calendário
      buscarColaboradores();
      carregarDiasLancadosDoMes();
    })
    .catch(function(e) {
      console.error(e);
      showAlert('danger', 'Erro ao salvar presenças.', 5000);
      btnConfirmarTudo.disabled = false;
    });
  }

  document.getElementById('btnConfirmarLancamentoModal')
    .addEventListener('click', function() {
      if (modalConfirmLanc) {
        modalConfirmLanc.hide();
      }
      enviarLancamentos();
    });

    document.addEventListener('click', function(evt) {
  var el = evt.target;

  // Se o clique não foi em input de cobertura nem em sugestão, fecha todas
  if (!el.closest('input[data-action="cobertura-input"]') &&
      !el.closest('button[data-action="cobertura-suggestion"]')) {
    listaIds.forEach(function(id) {
      var sugDiv = document.getElementById('cob-suggestions-' + String(id));
      if (sugDiv) {
        sugDiv.innerHTML = '';
        sugDiv.classList.add('d-none');
      }
    });
  }
});


}); // FIM DOMContentLoaded
</script>
