<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  >
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
  >
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .colaborador-row {
      transition: background-color 0.2s;
    }
    .colaborador-row:hover {
      background-color: #f8f9fa;
    }
    .checkbox-presenca {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Navbar padrão -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/dashboard">Controle de Presença</a>
      <div class="d-flex">
        <span class="navbar-text text-white me-3">
          Olá, <%= usuario.nome %> (<%= usuario.perfil %>)
        </span>
        <a href="/auth/logout" class="btn btn-outline-light btn-sm">Sair</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-calendar-check"></i> <%= title %></h2>
          <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="data" class="form-label">Data</label>
                <input type="date" class="form-control" id="data" required>
              </div>
              <div class="col-md-4">
                <label for="condominio" class="form-label">Condomínio</label>
                <select class="form-select" id="condominio" required>
                  <option value="">Selecione...</option>
                  <% condominios.forEach(cond => { %>
                    <option value="<%= cond.id %>"><%= cond.nome %></option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-4">
                <label for="posto" class="form-label">Posto</label>
                <select class="form-select" id="posto" required disabled>
                  <option value="">Selecione um condomínio primeiro</option>
                </select>
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-primary w-100" id="btnCarregar">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabela de colaboradores -->
        <div id="areaColaboradores" style="display: none;">
          <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <span><i class="bi bi-people"></i> Colaboradores</span>
              <div>
                <button type="button" class="btn btn-sm btn-light me-2" id="btnMarcarTodos">
                  <i class="bi bi-check-all"></i> Marcar Todos
                </button>
                <button type="button" class="btn btn-sm btn-light" id="btnDesmarcarTodos">
                  <i class="bi bi-x-lg"></i> Desmarcar Todos
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th style="width: 60px;" class="text-center">Presente</th>
                      <th>Colaborador</th>
                      <th>CPF</th>
                      <th>Empresa</th>
                      <th style="width: 150px;">Status</th>
                      <th>Observações</th>
                    </tr>
                  </thead>
                  <tbody id="tabelaColaboradores">
                    <!-- Preenchido via JS -->
                  </tbody>
                </table>
              </div>

              <div class="d-flex justify-content-end mt-3">
                <button type="button" class="btn btn-success btn-lg" id="btnSalvar">
                  <i class="bi bi-save"></i> Salvar Presenças
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="msgSemColaboradores" class="alert alert-info mt-3" style="display: none;">
          <i class="bi bi-info-circle"></i> Nenhum colaborador encontrado para este posto.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Define data de hoje como padrão
    document.getElementById('data').valueAsDate = new Date();

    let colaboradores = [];

    // Ao selecionar condomínio, carrega postos
    document.getElementById('condominio').addEventListener('change', async function() {
      const condominioId = this.value;
      const postosSelect = document.getElementById('posto');
      
      postosSelect.innerHTML = '<option value="">Carregando...</option>';
      postosSelect.disabled = true;

      if (!condominioId) {
        postosSelect.innerHTML = '<option value="">Selecione um condomínio primeiro</option>';
        return;
      }

      try {
        const res = await fetch('/presenca/api/postos/' + condominioId);
        const postos = await res.json();

        postosSelect.innerHTML = '<option value="">Selecione...</option>';
        postos.forEach(function(p) {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = p.nome;
          postosSelect.appendChild(option);
        });
        postosSelect.disabled = false;
      } catch (error) {
        console.error('Erro ao carregar postos:', error);
        alert('Erro ao carregar postos');
      }
    });

    // Botão Carregar
    document.getElementById('btnCarregar').addEventListener('click', async function() {
      const data = document.getElementById('data').value;
      const postoId = document.getElementById('posto').value;

      if (!data || !postoId) {
        alert('Preencha Data e Posto');
        return;
      }

      try {
        const res = await fetch('/presenca/api/colaboradores/' + postoId + '?data=' + data);
        colaboradores = await res.json();

        if (colaboradores.length === 0) {
          document.getElementById('areaColaboradores').style.display = 'none';
          document.getElementById('msgSemColaboradores').style.display = 'block';
          return;
        }

        document.getElementById('msgSemColaboradores').style.display = 'none';
        document.getElementById('areaColaboradores').style.display = 'block';

        renderizarTabela();
      } catch (error) {
        console.error('Erro ao carregar colaboradores:', error);
        alert('Erro ao carregar colaboradores');
      }
    });

    function renderizarTabela() {
      const tbody = document.getElementById('tabelaColaboradores');
      tbody.innerHTML = '';

      colaboradores.forEach(function(c, index) {
        const tr = document.createElement('tr');
        tr.className = 'colaborador-row';

        const checked = c.status === 'presente' ? 'checked' : '';

        tr.innerHTML = 
          '<td class="text-center">' +
            '<input type="checkbox" class="checkbox-presenca" data-index="' + index + '" ' + checked + '>' +
          '</td>' +
          '<td>' + c.nome + '</td>' +
          '<td>' + (c.cpf || '-') + '</td>' +
          '<td>' + (c.empresa || '-') + '</td>' +
          '<td>' +
            '<select class="form-select form-select-sm status-select" data-index="' + index + '">' +
              '<option value="presente"' + (c.status === 'presente' ? ' selected' : '') + '>Presente</option>' +
              '<option value="falta"' + (c.status === 'falta' ? ' selected' : '') + '>Falta</option>' +
              '<option value="folga"' + (c.status === 'folga' ? ' selected' : '') + '>Folga</option>' +
              '<option value="atestado"' + (c.status === 'atestado' ? ' selected' : '') + '>Atestado</option>' +
            '</select>' +
          '</td>' +
          '<td>' +
            '<input type="text" class="form-control form-control-sm obs-input" ' +
                   'data-index="' + index + '" value="' + (c.observacoes || '') + '" ' +
                   'placeholder="Observação...">' +
          '</td>';

        tbody.appendChild(tr);
      });

      // Checkbox -> status
      document.querySelectorAll('.checkbox-presenca').forEach(function(cb) {
        cb.addEventListener('change', function() {
          const idx = this.dataset.index;
          const statusSelect = document.querySelector('.status-select[data-index="' + idx + '"]');
          if (this.checked) {
            statusSelect.value = 'presente';
            colaboradores[idx].status = 'presente';
          } else {
            statusSelect.value = 'falta';
            colaboradores[idx].status = 'falta';
          }
        });
      });

      // Status -> checkbox
      document.querySelectorAll('.status-select').forEach(function(sel) {
        sel.addEventListener('change', function() {
          const idx = this.dataset.index;
          colaboradores[idx].status = this.value;
          const checkbox = document.querySelector('.checkbox-presenca[data-index="' + idx + '"]');
          checkbox.checked = (this.value === 'presente');
        });
      });

      // Observações
      document.querySelectorAll('.obs-input').forEach(function(inp) {
        inp.addEventListener('input', function() {
          const idx = this.dataset.index;
          colaboradores[idx].observacoes = this.value;
        });
      });
    }

    // Marcar todos
    document.getElementById('btnMarcarTodos').addEventListener('click', function() {
      colaboradores.forEach(function(c) {
        c.status = 'presente';
      });
      renderizarTabela();
    });

    // Desmarcar todos
    document.getElementById('btnDesmarcarTodos').addEventListener('click', function() {
      colaboradores.forEach(function(c) {
        c.status = 'falta';
      });
      renderizarTabela();
    });

    // Salvar
    document.getElementById('btnSalvar').addEventListener('click', async function() {
      const data = document.getElementById('data').value;
      const condominioId = document.getElementById('condominio').value;
      const postoId = document.getElementById('posto').value;

      if (!data || !condominioId || !postoId || colaboradores.length === 0) {
        alert('Dados incompletos');
        return;
      }

      const presencas = colaboradores.map(function(c) {
        return {
          colaborador_id: c.id,
          status: c.status,
          observacoes: c.observacoes || ''
        };
      });

      try {
        const res = await fetch('/presenca/api/salvar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            data: data,
            condominio_id: condominioId,
            posto_id: postoId,
            presencas: presencas
          })
        });

        const result = await res.json();

        if (result.success) {
          alert(result.message);
          document.getElementById('btnCarregar').click();
        } else {
          alert(result.message || 'Erro ao salvar');
        }
      } catch (error) {
        console.error('Erro ao salvar:', error);
        alert('Erro ao salvar presenças');
      }
    });
  </script>
</body>
</html>
