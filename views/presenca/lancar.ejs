<div class="container mt-4">
  <h1 class="h4 mb-4">Lançar Presença Diária</h1>

  <div class="card mb-3">
    <div class="card-body">
      <form id="formFiltro" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Data *</label>
          <input type="date" class="form-control" id="inputData" name="data" required>
        </div>

        <div class="col-md-7">
          <label class="form-label">Condomínio *</label>
          <select class="form-select" id="inputCondominio" name="condominio_id" required>
            <option value="">Selecione...</option>
            <% condominios.forEach(cond => { %>
              <option value="<%= cond.id %>"><%= cond.nome %></option>
            <% }) %>
          </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <button type="button" id="btnBuscar" class="btn btn-primary w-100" disabled>Buscar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
    <button type="button" class="btn btn-outline-success btn-sm" id="btnSelecionarTodosPresente" disabled>
      Selecionar todos: Presente
    </button>

    <button type="button" class="btn btn-success btn-sm" id="btnConfirmarTudo" disabled>
      Confirmar lançamentos
    </button>

    <span class="ms-auto text-muted" id="resumo"></span>
  </div>

  <div id="alerta" class="alert d-none" role="alert"></div>

  <div id="areaColaboradores">
    <div class="alert alert-info">
      Selecione data e condomínio para carregar os colaboradores.
    </div>
  </div>
</div>

<script>
  // Status disponíveis
  var STATUSES = [
    { key: 'presente', label: 'Presente', btn: 'btn-outline-success', btnActive: 'btn-success' },
    { key: 'falta',    label: 'Falta',    btn: 'btn-outline-danger',  btnActive: 'btn-danger' },
    { key: 'folga',    label: 'Folga',    btn: 'btn-outline-secondary', btnActive: 'btn-secondary' },
    { key: 'atestado', label: 'Atestado', btn: 'btn-outline-warning', btnActive: 'btn-warning' },
    { key: 'ferias',   label: 'Férias',   btn: 'btn-outline-info',    btnActive: 'btn-info' }
  ];

  // Para quais status exigimos/mostramos observação
  var STATUS_COM_OBS = ['falta', 'folga', 'atestado', 'ferias'];

  var inputData = document.getElementById('inputData');
  var inputCondominio = document.getElementById('inputCondominio');
  var btnBuscar = document.getElementById('btnBuscar');
  var btnConfirmarTudo = document.getElementById('btnConfirmarTudo');
  var btnSelecionarTodosPresente = document.getElementById('btnSelecionarTodosPresente');
  var areaColaboradores = document.getElementById('areaColaboradores');
  var resumo = document.getElementById('resumo');
  var alerta = document.getElementById('alerta');

  // Estado local da tela (NÃO salva até confirmar)
  var estado = {};
  var listaIds = [];
  window.__colaboradoresRaw = {};

  function hojeISO() {
    var d = new Date();
    var yyyy = d.getFullYear();
    var mm = String(d.getMonth() + 1).padStart(2, '0');
    var dd = String(d.getDate()).padStart(2, '0');
    return yyyy + '-' + mm + '-' + dd;
  }

  function showAlert(type, msg) {
    alerta.className = 'alert alert-' + type;
    alerta.textContent = msg;
    alerta.classList.remove('d-none');
    setTimeout(function() { alerta.classList.add('d-none'); }, 3000);
  }

  function badgeStatus(status) {
    if (!status) return { cls: 'bg-light text-dark', text: 'Não lançado' };
    if (status === 'presente') return { cls: 'bg-success', text: 'Presente' };
    if (status === 'falta') return { cls: 'bg-danger', text: 'Falta' };
    if (status === 'folga') return { cls: 'bg-secondary', text: 'Folga' };
    if (status === 'atestado') return { cls: 'bg-warning text-dark', text: 'Atestado' };
    if (status === 'ferias') return { cls: 'bg-info text-dark', text: 'Férias' };
    return { cls: 'bg-light text-dark', text: status };
  }

  function escapeHtml(str) {
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function isPendente(id) {
    var s = estado[String(id)];
    if (!s) return false;
    return (s.status !== s.originalStatus) || ((s.observacoes || '') !== (s.originalObs || '')) || !s.presenca_id;
  }

  function atualizarResumo() {
    var total = listaIds.length;
    var pendentes = 0;
    var jaSalvos = 0;

    listaIds.forEach(function(id) {
      if (isPendente(id)) pendentes++;
      else jaSalvos++;
    });

    resumo.textContent = 'Total: ' + total + ' | Pendentes: ' + pendentes + ' | Já salvos: ' + jaSalvos;

    btnConfirmarTudo.disabled = (total === 0);
    btnSelecionarTodosPresente.disabled = (total === 0);
  }

  function renderCard(c) {
    var id = String(c.id);
    var s = estado[id];
    var statusAtual = (s && s.status != null && s.status !== '') ? s.status : '';
    var obsAtual = (s && s.observacoes) ? s.observacoes : '';

    var badge = badgeStatus(statusAtual);
    var pendente = isPendente(id);

    var borderClass =
      statusAtual === 'presente' ? 'border-success' :
      statusAtual === 'falta' ? 'border-danger' :
      'border-secondary';

    var pendBadge = pendente
      ? '<span class="badge bg-primary">Pendente</span>'
      : '<span class="badge bg-success">Confirmado</span>';

    var btns = '';
    STATUSES.forEach(function(st) {
      var active = (st.key === statusAtual);
      var cls = active ? st.btnActive : st.btn;
      btns += '<button type="button" class="btn ' + cls + ' btn-sm" data-action="set-status" data-id="' + id + '" data-status="' + st.key + '">' + st.label + '</button> ';
    });

    var obsVisible = STATUS_COM_OBS.indexOf(statusAtual) !== -1;
    var obsHtml = '<div class="mt-2 ' + (obsVisible ? '' : 'd-none') + '" id="obs-wrap-' + id + '">' +
      '<label class="form-label mb-1">Observação</label>' +
      '<input type="text" class="form-control form-control-sm" id="obs-' + id + '" ' +
      'placeholder="Ex: Folga autorizada, Atestado entregue..." ' +
      'value="' + escapeHtml(obsAtual) + '" data-action="set-obs" data-id="' + id + '">' +
      '</div>';

    var cpfText = c.cpf ? ' • CPF: ' + escapeHtml(c.cpf) : '';
    var empresaText = escapeHtml(c.empresa || 'Sem empresa');
    var postoText = c.posto_nome ? ' • ' + escapeHtml(c.posto_nome) : '';

    return ''
      + '<div id="card-' + id + '" class="card mb-2 border-start border-3 ' + borderClass + '">'
      + '  <div class="card-body p-3">'
      + '    <div class="d-flex justify-content-between align-items-start gap-3">'
      + '      <div>'
      + '        <div class="fw-semibold">' + escapeHtml(c.nome) + '</div>'
      + '        <div class="text-muted small">' + empresaText + cpfText + postoText + '</div>'
      + '      </div>'
      + '      <div class="text-end">'
      + '        <span class="badge ' + badge.cls + '">' + badge.text + '</span>'
      + '        <div class="mt-1">' + pendBadge + '</div>'
      + '      </div>'
      + '    </div>'
      + '    <div class="mt-2 d-flex flex-wrap gap-2">' + btns + '</div>'
      +      obsHtml
      + '  </div>'
      + '</div>';
  }

  function rerenderCardById(id, colaboradorRaw) {
    var el = document.getElementById('card-' + id);
    if (!el) return;
    el.outerHTML = renderCard(colaboradorRaw);
  }

  function buscarColaboradores() {
    var data = inputData.value;
    var condId = inputCondominio.value;

    if (!data || !condId) {
      showAlert('warning', 'Preencha data e condomínio.');
      return;
    }

    alerta.classList.add('d-none');

    areaColaboradores.innerHTML =
      '<div class="text-center py-4"><div class="spinner-border" role="status"></div><div class="mt-2">Carregando colaboradores...</div></div>';

    fetch('/presenca/api/colaboradores/condominio/' + condId + '?data=' + encodeURIComponent(data))
      .then(function(resp) { return resp.json(); })
      .then(function(colaboradores) {
        if (!Array.isArray(colaboradores) || colaboradores.length === 0) {
          estado = {};
          listaIds = [];
          window.__colaboradoresRaw = {};
          areaColaboradores.innerHTML = '<div class="alert alert-warning">Nenhum colaborador encontrado para este condomínio.</div>';
          atualizarResumo();
          return;
        }

        estado = {};
        listaIds = colaboradores.map(function(c) { return String(c.id); });
        window.__colaboradoresRaw = {};

        colaboradores.forEach(function(c) {
          var id = String(c.id);
          var originalStatus = c.status || '';      // não força "presente"
          var originalObs = c.observacoes || '';
          estado[id] = {
            status: originalStatus,                 // pode ser vazio (não lançado)
            observacoes: originalObs,
            originalStatus: originalStatus,
            originalObs: originalObs,
            presenca_id: c.presenca_id || null
          };
          window.__colaboradoresRaw[id] = c;
        });

        var html = '';
        colaboradores.forEach(function(c) {
          html += renderCard(c);
        });
        areaColaboradores.innerHTML = html;

        atualizarResumo();
      })
      .catch(function(e) {
        console.error(e);
        areaColaboradores.innerHTML = '<div class="alert alert-danger">Erro ao buscar colaboradores.</div>';
        estado = {};
        listaIds = [];
        window.__colaboradoresRaw = {};
        atualizarResumo();
      });
  }

  // Eventos
  inputData.value = hojeISO();

  inputCondominio.addEventListener('change', function() {
    btnBuscar.disabled = !this.value;
  });

  btnBuscar.addEventListener('click', buscarColaboradores);

  // Clique nos botões de status
  areaColaboradores.addEventListener('click', function(evt) {
    var btn = evt.target.closest('button[data-action="set-status"]');
    if (!btn) return;

    var id = String(btn.getAttribute('data-id'));
    var novoStatus = btn.getAttribute('data-status');

    var s = estado[id];
    if (!s) return;

    s.status = novoStatus;

    if (STATUS_COM_OBS.indexOf(novoStatus) === -1) {
      s.observacoes = '';
    }

    estado[id] = s;

    var raw = window.__colaboradoresRaw[id];
    if (raw) rerenderCardById(id, raw);

    atualizarResumo();
  });

  // Digitação de observação
  areaColaboradores.addEventListener('input', function(evt) {
    var inp = evt.target.closest('input[data-action="set-obs"]');
    if (!inp) return;

    var id = String(inp.getAttribute('data-id'));
    var s = estado[id];
    if (!s) return;

    s.observacoes = inp.value || '';
    estado[id] = s;

    atualizarResumo();
  });

  // Selecionar todos Presente
  btnSelecionarTodosPresente.addEventListener('click', function() {
    listaIds.forEach(function(id) {
      var s = estado[String(id)];
      if (!s) return;
      s.status = 'presente';
      s.observacoes = '';
      estado[String(id)] = s;

      var raw = window.__colaboradoresRaw[String(id)];
      if (raw) rerenderCardById(String(id), raw);
    });
    atualizarResumo();
  });

  // Confirmar lançamentos
  btnConfirmarTudo.addEventListener('click', function() {
    var data = inputData.value;
    var condId = inputCondominio.value;

    if (!data || !condId) {
      showAlert('warning', 'Preencha data e condomínio.');
      return;
    }

    if (listaIds.length === 0) {
      showAlert('warning', 'Nenhum colaborador para confirmar.');
      return;
    }

    var condominioTexto = inputCondominio.options[inputCondominio.selectedIndex].text;

    var msg = 'Confirma salvar os lançamentos?\n\n' +
      'Data: ' + data + '\n' +
      'Condomínio: ' + condominioTexto + '\n' +
      'Total de colaboradores: ' + listaIds.length + '\n\n' +
      'Isso vai gravar/atualizar as presenças no sistema.';

    if (!confirm(msg)) {
      return;
    }

    var presencas = listaIds.map(function(id) {
      var s = estado[String(id)];
      var raw = window.__colaboradoresRaw[String(id)];
      var postoIdColab = raw && raw.posto_id ? raw.posto_id : null;

      return {
        colaborador_id: Number(id),
        status: (s && s.status) ? s.status : '',
        observacoes: ((s && s.observacoes) ? s.observacoes : '').trim(),
        posto_id: postoIdColab
      };
    });

    btnConfirmarTudo.disabled = true;

    fetch('/presenca/api/lancar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        data: data,
        condominio_id: condId,
        presencas: presencas
      })
    })
    .then(function(resp) { return resp.json(); })
    .then(function(result) {
      if (!result.success) {
        showAlert('danger', result.message || 'Erro ao salvar presenças.');
        btnConfirmarTudo.disabled = false;
        return;
      }

      showAlert('success', 'Presenças confirmadas com sucesso!');
      buscarColaboradores();
    })
    .catch(function(e) {
      console.error(e);
      showAlert('danger', 'Erro ao salvar presenças.');
      btnConfirmarTudo.disabled = false;
    });
  });
</script>
