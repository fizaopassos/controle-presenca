<div class="container my-4 fade-in">

  <!-- Page Header -->
  <div class="page-header d-flex justify-content-between align-items-start flex-wrap gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1">
        <i class="bi bi-building-check text-primary me-2"></i>        Empresas Fornecedoras
      </h1>
      <p class="subtitle mb-0">
        Gerencie as empresas prestadoras de serviço
      </p>
    </div>
    <button
type="button"
class="btn btn-primary"
hx-get="/empresas/novo?partial=1"
hx-target="#empresaModalBody"
hx-swap="innerHTML">

<i class="bi bi-plus-circle me-1"></i>
Nova Empresa
</button>
  </div>

  <!-- Filtro Rápido -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="input-group">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input 
          type="text" 
          class="form-control" 
          id="filtroNome" 
          placeholder="Buscar empresa por nome..."
        >
      </div>
    </div>
  </div>

  <!-- Tabela de Empresas -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>
        <i class="bi bi-list-ul me-2"></i>
        Lista de Empresas
      </span>
      <span class="badge bg-primary" id="totalEmpresas">
        <%= empresas.length %> empresa<%= empresas.length !== 1 ? 's' : '' %>
      </span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Nome</th>
              <th>CNPJ</th>
              <th>Telefone</th>
              <th>Email</th>
              <th class="text-center">Status</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody id="tabelaEmpresas">
            <% if (empresas.length === 0) { %>
              <tr id="linhaVaziaEmpresas">
                <td colspan="6" class="text-center py-5">
                  <i class="bi bi-inbox display-6 text-muted d-block mb-2"></i>
                  <p class="text-muted mb-3">Nenhuma empresa cadastrada ainda.</p>
                  <button
type="button"
class="btn btn-primary"
data-bs-toggle="modal"
data-bs-target="#empresaModal"
hx-get="/empresas/novo?partial=1"
hx-target="#empresaModalBody"
hx-swap="innerHTML">

<i class="bi bi-plus-circle me-1"></i>
Cadastrar Primeira Empresa
</button>
                </td>
              </tr>
            <% } else { %>
              <% empresas.forEach(emp => { %>
                <%- include('_linha', { empresa: emp }) %>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Scripts específicos da página -->
<script>
  // Filtro de busca em tempo real
  const filtroInput = document.getElementById('filtroNome');

  if (filtroInput) {
    filtroInput.addEventListener('input', function() {
      const termo = this.value.toLowerCase();
      const linhas = document.querySelectorAll('#tabelaEmpresas tr[data-nome]');
      let visiveis = 0;

      linhas.forEach(linha => {
        const nome = (linha.dataset.nome || '').toLowerCase();
        if (nome.includes(termo)) {
          linha.style.display = '';
          visiveis++;
        } else {
          linha.style.display = 'none';
        }
      });

      document.getElementById('totalEmpresas').textContent = 
        visiveis + ' empresa' + (visiveis !== 1 ? 's' : '');
    });
  }

  // Abrir modal quando o conteúdo do formulário for carregado via HTMX
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.target && evt.target.id === 'empresaModalBody') {
      const modalEl = document.getElementById('empresaModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();

      // Remove linha vazia se existir (primeira empresa cadastrada)
      const linhaVazia = document.getElementById('linhaVaziaEmpresas');
      if (linhaVazia) {
        linhaVazia.remove();
      }
    }
  });

  // Fechar modal após salvar com sucesso
  document.body.addEventListener('htmx:afterRequest', function(evt) {
if (!evt.detail || !evt.detail.successful) return;

const el = evt.detail.elt;
if (!el || !el.closest) return;

// se a request veio do botão/elemento dentro do form de empresa, fecha o modal
if (el.closest('#formEmpresa')) {
const modalEl = document.getElementById('empresaModal');
const modal = bootstrap.Modal.getInstance(modalEl);
if (modal) modal.hide();
}
});
</script>

<!-- Modal para criar/editar Empresa via HTMX -->
<div class="modal fade" id="empresaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-empresa">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="empresaModalTitle">Empresa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="empresaModalBody">
        <!-- Conteúdo do formulário virá via HTMX -->
      </div>
    </div>
  </div>
</div>
