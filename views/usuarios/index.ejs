<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-people"></i> Usuários</h2>
      <a href="/usuarios/novo" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Novo Usuário
      </a>
    </div>

    <div class="card">
      <div class="card-header bg-light">
        <div class="row g-2">
          <div class="col-md-4">
            <input 
              type="text" 
              id="filtroNome" 
              class="form-control" 
              placeholder="Filtrar por nome ou e-mail..."
            >
          </div>
        </div>
      </div>
      <div class="card-body">
        <% if (usuarios && usuarios.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th style="width: 60px;">#</th>
                  <th>Nome</th>
                  <th>E-mail</th>
                  <th style="width: 120px;">Perfil</th>
                  <th style="width: 140px;">Ações</th>
                </tr>
              </thead>
              <tbody id="tabelaUsuarios">
                <% usuarios.forEach((u, index) => { %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td class="td-nome"><%= u.nome %></td>
                    <td class="td-email"><%= u.email %></td>
                    <td>
                      <% if (u.perfil === 'ADMIN') { %>
                        <span class="badge bg-danger">ADMIN</span>
                      <% } else if (u.perfil === 'GESTOR') { %>
                        <span class="badge bg-primary">GESTOR</span>
                      <% } else { %>
                        <span class="badge bg-secondary"><%= u.perfil %></span>
                      <% } %>
                    </td>
                    <td>
                      <!-- Editar -->
                      <a 
                        href="/usuarios/editar/<%= u.id %>" 
                        class="btn btn-sm btn-outline-primary" 
                        title="Editar"
                      >
                        <i class="bi bi-pencil"></i>
                      </a>

                      <!-- Excluir: usando data-atributos para evitar problemas de aspas -->
                      <% if (usuario && u.id !== usuario.id) { %>
                        <button 
                          type="button"
                          class="btn btn-sm btn-outline-danger btn-excluir"
                          data-id="<%= u.id %>"
                          data-nome="<%- u.nome %>"
                          title="Excluir"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-info text-center">
            Nenhum usuário cadastrado.
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
  // Filtro simples por nome/e-mail (apenas front-end)
  (function() {
    const filtroInput = document.getElementById('filtroNome');
    const tabela = document.getElementById('tabelaUsuarios');

    if (filtroInput && tabela) {
      filtroInput.addEventListener('input', function () {
        const termo = this.value.toLowerCase();
        const linhas = tabela.querySelectorAll('tr');

        linhas.forEach(tr => {
          const nome = (tr.querySelector('.td-nome')?.textContent || '').toLowerCase();
          const email = (tr.querySelector('.td-email')?.textContent || '').toLowerCase();
          tr.style.display = (nome.includes(termo) || email.includes(termo)) ? '' : 'none';
        });
      });
    }

    // Exclusão via fetch DELETE, usando data-atributos
    document.querySelectorAll('.btn-excluir').forEach(btn => {
      btn.addEventListener('click', async function () {
        const id = this.getAttribute('data-id');
        const nome = this.getAttribute('data-nome') || '';

        const mensagem = 'Tem certeza que deseja excluir o usuário "' + nome + '"?\n\nEsta ação não pode ser desfeita.';
        if (!confirm(mensagem)) {
          return;
        }

        try {
          const response = await fetch('/usuarios/excluir/' + id, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await response.json();

          if (data.sucesso) {
            alert('Usuário excluído com sucesso!');
            location.reload();
          } else {
            alert(data.erro || 'Erro ao excluir usuário');
          }
        } catch (error) {
          console.error('Erro ao excluir usuário:', error);
          alert('Erro ao excluir usuário. Tente novamente.');
        }
      });
    });
  })();
</script>
